unbind-key -a                                           # Remove all existing key bindings to start fresh
# Now reinsert all the regular tmux keys

unbind r                                                    # Remove default 'r' binding
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded! Use prefix+I to install new plugins, prefix+U to update."  

# ########## Session Related ################
unbind R
bind R command-prompt "rename-window %%"
bind '$' command-prompt "rename-session %%"
bind ^D detach                                          # Prefix+Ctrl+D: detach from session
bind l switch-client -l                                 # Prefix+l: toggle to last session
# bind s choose-session                                   # Prefix+s: interactive session # chooser. works well but sessionx better)
# ########## End Session Related ################

# #########  Client ###############
bind ^X lock-server                                     # Prefix+Ctrl+X: lock tmux server
bind * list-clients                                     # Prefix+*: show all connected clients
bind ^L refresh-client                                  # Prefix+Ctrl+L: refresh tmux client
bind : command-prompt                                   # Prefix+:: open tmux command prompt
# bind ; command-prompt                                   # Prefix+:; open tmux command prompt

# #########  End Client ###############

# ########## Copy Mode ################
bind v  copy-mode                                        
bind ] paste-buffer                                   # whats this?

bind -T copy-mode-vi v send-keys -X begin-selection     # In copy mode, 'v' starts visual selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'  # In copy mode, 'y' copies to macOS clipboard
bind -T copy-mode-vi H send-keys -X back-to-indentation # 'H' goes to first non-blank character (like Vim ^)
bind -T copy-mode-vi L send-keys -X end-of-line         # 'L' goes to end of line (like Vim g_)
bind -T copy-mode-vi C-c send-keys -X clear-selection    # Ctrl+C clears selection, stays in copy mode (like Escape normally does)
bind -T copy-mode-vi Escape send-keys -X cancel          # Escape exits copy mode entirely (like Ctrl+C normally does)
bind -T copy-mode-vi / command-prompt -p "(search up)" "send -X search-backward \"%%%\""  # # '/' searches up (backward)

# ########## End Copy Mode ################

# ###########  window manipulation ###########
# Prefix+Ctrl+C: create new window inheriting current pane's directory
bind c new-window -c "#{pane_current_path}"
bind H previous-window
# Prefix+L: go to next window
bind L next-window

bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9
bind 0 select-window -t 10

bind ^A last-window                                     # Prefix+Ctrl+A: switch to last window
bind ^W list-windows                                    # Prefix+Ctrl+W: list all windows

# Window operations key table (Prefix, then w enters window-ops mode)
bind w switch-client -T window-ops                      # Prefix+w: enter window operations mode

# TODO: make this just equalize panes, right now its changing it to be split horizontally.
bind -T window-ops e select-layout tiled \; display-message "Panes equalized"  # Prefix+w+e: equalize all panes
bind -T window-ops w resize-pane -Z                     # Prefix+w+w: toggle zoom of current pane
bind -T window-ops l list-windows                       # Prefix+w+l: list all windows (moved from 'w')
bind -T window-ops d break-pane -d \; display-message "Pane hidden"          # Prefix+w+d: hide current pane
bind -T window-ops D join-pane -s ! \; display-message "Pane restored"       # Prefix+w+D: restore last hidden pane

# bind -T window-ops e resize-pane -Z 
bind -T window-ops e select-layout -E 

bind -T window-ops s select-layout even-horizontal 
bind -T window-ops S select-layout even-vertical 

# Prefix+w+m: move pane to window or window.pane in current session (e.g. "2" or "2.1")
bind -T window-ops m command-prompt -p "Move to window[.pane]:" "move-pane -t ':%%'"  
# Prefix+w+M: move pane interactively
bind -T window-ops M choose-window "move-pane -t '%%'"

# Prefix+w+v: split window horizontally (side by side panes)
bind -T window-ops v split-window -h -c "#{pane_current_path}" 
# Prefix+w+h: split window vertically (stacked panes)
bind -T window-ops h split-window -v -c "#{pane_current_path}" 

# unbind %                                                # Remove default horizontal split binding
# bind | split-window -h                                  # Prefix+|: split window horizontally
# unbind '"'                                              # Remove default vertical split binding  
# bind - split-window -v                                  # Prefix+-: split window vertically

# Prefix+": interactive window chooser
# TODO: reassign
bind '"' choose-window
bind "'" choose-window
# ################## end window manipulation ##################

# ########### Panes ###########
bind ^c kill-pane                                        # Prefix+c: close/kill current pane
bind x swap-pane -D                                     # Prefix+x: swap current pane with next pane
bind z resize-pane -Z                                   # Prefix+z: toggle pane zoom (fullscreen)

# Directional pane swapping (Prefix+s enters swap mode)
bind s switch-client -T swap-pane                        # Prefix+s: enter pane swap mode
bind -T swap-pane h swap-pane -s '{left-of}' \; display-message "Swapped with left pane"
bind -T swap-pane j swap-pane -s '{down-of}' \; display-message "Swapped with down pane"
bind -T swap-pane k swap-pane -s '{up-of}' \; display-message "Swapped with up pane"
bind -T swap-pane l swap-pane -s '{right-of}' \; display-message "Swapped with right pane"

# bind * setw synchronize-panes                         # Prefix+*: toggle synchronized input to all panes
bind P set pane-border-status

# Vim detection for smart key forwarding (used by navigation and resize bindings)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Tmux resize keybindings matching nvim smart-splits: Alt+Shift+hjkl
# Check if vim is running, if so pass keys to vim, otherwise resize tmux pane
bind -r -T root M-H if-shell "$is_vim" "send-keys M-H" "resize-pane -L 5"
bind -r -T root M-J if-shell "$is_vim" "send-keys M-J" "resize-pane -D 2"
bind -r -T root M-K if-shell "$is_vim" "send-keys M-K" "resize-pane -U 2"
bind -r -T root M-L if-shell "$is_vim" "send-keys M-L" "resize-pane -R 5"

# Alternative resize bindings for when Alt+Shift doesn't work in non-nvim panes (works)
bind -r M-h resize-pane -L 5                           # Prefix+Meta+h: resize pane left by 5 cells
bind -r M-l resize-pane -R 5                           # Prefix+Meta+l: resize pane right by 5 cells  
bind -r M-j resize-pane -D 2                           # Prefix+Meta+j: resize pane down by 2 cells
bind -r M-k resize-pane -U 2                           # Prefix+Meta+k: resize pane up by 2 cells

# ####### Resizing and Moving Panes ########
# pane switching with command+h/j/k/l (i have mac 'command' key mapped to
# control+alt+shift as proxy. That proxy remapping done with karabiner
# elements) 
# FIX: its not working. I can switch from nvim tmux pane to another pane,  but
# these mappings dont work if im on some tmux pane that is not nvim can't
# switch from Tmux terminal back to tmux pane with nvim
bind C-M-S-H select-pane -L                  # Commented: intended for command+h pane switching
bind C-M-S-J select-pane -D                  # Commented: intended for command+j pane switching
bind C-M-S-K select-pane -U                  # Commented: intended for command+k pane switching
bind C-M-S-L select-pane -R                  # Commented: intended for command+l pane switching

# ########### End Panes ###########

bind K send-keys "clear"\; send-keys "Enter"           # Prefix+K: clear terminal and send enter



